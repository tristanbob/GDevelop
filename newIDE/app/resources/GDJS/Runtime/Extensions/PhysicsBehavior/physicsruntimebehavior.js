var gdjs;(function(n){class c{constructor(t,e){this.stepped=!1;this.totalTime=0;this.fixedTimeStep=1/60,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this.invScaleX=1/this.scaleX,this.invScaleY=1/this.scaleY;const i=Box2D.b2World,s=Box2D.b2Vec2;this.world=new i(new s(e.gravityX,-e.gravityY),!0),this.world.SetAutoClearForces(!1),this.staticBody=this.world.CreateBody(new Box2D.b2BodyDef),this.contactListener=new Box2D.JSContactListener,this.contactListener.BeginContact=function(a){const o=Box2D.wrapPointer(a,Box2D.b2Contact);if(o.GetFixtureA().GetBody()==null||o.GetFixtureB().GetBody()==null)return;const r=o.GetFixtureA().GetBody().gdjsAssociatedBehavior,h=o.GetFixtureB().GetBody().gdjsAssociatedBehavior;r.currentContacts.push(h),h.currentContacts.push(r)},this.contactListener.EndContact=function(a){const o=Box2D.wrapPointer(a,Box2D.b2Contact);if(o.GetFixtureA().GetBody()==null||o.GetFixtureB().GetBody()==null||o.GetFixtureA().GetBody()===null||o.GetFixtureB().GetBody()===null)return;const r=o.GetFixtureA().GetBody().gdjsAssociatedBehavior,h=o.GetFixtureB().GetBody().gdjsAssociatedBehavior;let l=r.currentContacts.indexOf(h);l!==-1&&r.currentContacts.splice(l,1),l=h.currentContacts.indexOf(r),l!==-1&&h.currentContacts.splice(l,1)},this.contactListener.PreSolve=function(){},this.contactListener.PostSolve=function(){},this.world.SetContactListener(this.contactListener)}static getSharedData(t,e){if(!t.physicsSharedData){const i=t.getInitialSharedDataForBehavior(e);t.physicsSharedData=new n.PhysicsSharedData(t,i)}return t.physicsSharedData}step(t){if(this.totalTime+=t,this.totalTime>this.fixedTimeStep){let e=Math.floor(this.totalTime/this.fixedTimeStep);this.totalTime-=e*this.fixedTimeStep,e>5&&(e=5);for(let i=0;i<e;i++)this.world.Step(this.fixedTimeStep,6,10);this.world.ClearForces()}this.stepped=!0}}n.PhysicsSharedData=c,n.registerRuntimeSceneUnloadedCallback(function(y){y.physicsSharedData&&Box2D.destroy(y.physicsSharedData.world)});class d extends n.RuntimeBehavior{constructor(t,e,i){super(t,e,i);this._box2DBody=null;this._objectOldWidth=0;this._objectOldHeight=0;this._objectOldX=0;this._objectOldY=0;this._objectOldAngle=0;this.currentContacts=[];this._dynamic=e.dynamic,this._angularDamping=e.angularDamping,this._linearDamping=e.linearDamping,this._isBullet=e.isBullet,this._fixedRotation=e.fixedRotation,this._massDensity=e.massDensity,this._averageFriction=e.averageFriction,this._averageRestitution=e.averageRestitution,this._shapeType=e.shapeType,this.currentContacts!==void 0&&(this.currentContacts.length=0),this._sharedData=c.getSharedData(t,e.name),this._tempb2Vec2=new Box2D.b2Vec2}updateFromBehaviorData(t,e){return t.dynamic!==e.dynamic&&(e.dynamic?this.setDynamic():this.setStatic()),t.angularDamping!==e.angularDamping&&this.setAngularDamping(e.angularDamping),t.linearDamping!==e.linearDamping&&this.setLinearDamping(e.linearDamping),t.isBullet!==e.isBullet&&(e.isBullet?this.setAsBullet():this.dontSetAsBullet()),t.fixedRotation!==e.fixedRotation&&(e.fixedRotation?this.setFixedRotation():this.setFreeRotation()),!(t.massDensity!==e.massDensity||t.averageFriction!==e.averageFriction||t.averageRestitution!==e.averageRestitution||t.shapeType!==e.shapeType)}onDeActivate(){this._box2DBody!==null&&(this._sharedData.world.DestroyBody(this._box2DBody),this._box2DBody=null)}onDestroy(){this.onDeActivate()}b2Vec2(t,e){return this._tempb2Vec2.set_x(t),this._tempb2Vec2.set_y(e),this._tempb2Vec2}createBody(){const t=new Box2D.b2BodyDef;t.set_type(this._dynamic?Box2D.b2_dynamicBody:Box2D.b2_staticBody),t.set_position(this.b2Vec2((this.owner.getDrawableX()+this.owner.getWidth()/2)*this._sharedData.invScaleX,-(this.owner.getDrawableY()+this.owner.getHeight()/2)*this._sharedData.invScaleY)),t.set_angle(-n.toRad(this.owner.getAngle())),t.set_angularDamping(this._angularDamping>0?this._angularDamping:0),t.set_linearDamping(this._linearDamping>0?this._linearDamping:0),t.set_bullet(this._isBullet),t.set_fixedRotation(this._fixedRotation),this._box2DBody=this._sharedData.world.CreateBody(t),this._box2DBody.gdjsAssociatedBehavior=this;let e=null;if(this._shapeType==="Circle"){const i=new Box2D.b2CircleShape;i.set_m_radius((this.owner.getWidth()*this._sharedData.invScaleX+this.owner.getHeight()*this._sharedData.invScaleY)/4),i.get_m_radius()<=0&&i.set_m_radius(1),e=new Box2D.b2FixtureDef,e.set_shape(i)}else{const i=new Box2D.b2PolygonShape;i.SetAsBox((this.owner.getWidth()>0?this.owner.getWidth():1)*this._sharedData.invScaleX/2,(this.owner.getHeight()>0?this.owner.getHeight():1)*this._sharedData.invScaleY/2),e=new Box2D.b2FixtureDef,e.set_shape(i)}e.set_density(this._massDensity),e.set_friction(this._averageFriction),e.set_restitution(this._averageRestitution),this._box2DBody.CreateFixture(e),this._objectOldWidth=this.owner.getWidth(),this._objectOldHeight=this.owner.getHeight()}doStepPreEvents(t){this._box2DBody===null&&this.createBody(),this._sharedData.stepped||this._sharedData.step(t.getTimeManager().getElapsedTime()/1e3),this.owner.setX(this._box2DBody.GetPosition().get_x()*this._sharedData.scaleX-this.owner.getWidth()/2+this.owner.getX()-this.owner.getDrawableX()),this.owner.setY(-this._box2DBody.GetPosition().get_y()*this._sharedData.scaleY-this.owner.getHeight()/2+this.owner.getY()-this.owner.getDrawableY()),this.owner.setAngle(-n.toDegrees(this._box2DBody.GetAngle())),this._objectOldX=this.owner.getX(),this._objectOldY=this.owner.getY(),this._objectOldAngle=this.owner.getAngle()}getBox2DBody(){return this._box2DBody===null&&this.createBody(),this._box2DBody}doStepPostEvents(t){if(this._box2DBody===null&&this.createBody(),this._objectOldWidth!==this.owner.getWidth()||this._objectOldHeight!==this.owner.getHeight()){const i=this._box2DBody.GetAngularVelocity(),s=this._box2DBody.GetLinearVelocity().get_x(),a=this._box2DBody.GetLinearVelocity().get_y();this._sharedData.world.DestroyBody(this._box2DBody),this.createBody(),this._box2DBody.SetAngularVelocity(i),this._box2DBody.SetLinearVelocity(this.b2Vec2(s,a))}if(this._sharedData.stepped=!1,this._objectOldX==this.owner.getX()&&this._objectOldY==this.owner.getY()&&this._objectOldAngle==this.owner.getAngle())return;const e=this.b2Vec2((this.owner.getDrawableX()+this.owner.getWidth()/2)*this._sharedData.invScaleX,-(this.owner.getDrawableY()+this.owner.getHeight()/2)*this._sharedData.invScaleY);this._box2DBody.SetTransform(e,-n.toRad(this.owner.getAngle())),this._box2DBody.SetAwake(!0)}setStatic(){this._dynamic=!1,this._box2DBody===null&&this.createBody(),this._box2DBody.SetType(Box2D.b2_staticBody)}setDynamic(){this._dynamic=!0,this._box2DBody===null&&this.createBody(),this._box2DBody.SetType(Box2D.b2_dynamicBody),this._box2DBody.SetAwake(!0)}setFixedRotation(){this._fixedRotation=!0,this._box2DBody===null&&this.createBody(),this._box2DBody.SetFixedRotation(!0)}setFreeRotation(){this._fixedRotation=!1,this._box2DBody===null&&this.createBody(),this._box2DBody.SetFixedRotation(!1)}setAsBullet(){this._isBullet=!0,this._box2DBody===null&&this.createBody(),this._box2DBody.SetBullet(!0)}dontSetAsBullet(){this._isBullet=!1,this._box2DBody===null&&this.createBody(),this._box2DBody.SetBullet(!1)}applyImpulse(t,e){this._box2DBody===null&&this.createBody(),this._box2DBody.ApplyLinearImpulse(this.b2Vec2(t,-e),this._box2DBody.GetPosition())}applyImpulseUsingPolarCoordinates(t,e){t=n.toRad(t),this._box2DBody===null&&this.createBody(),this._box2DBody.ApplyLinearImpulse(this.b2Vec2(Math.cos(t)*e,-Math.sin(t)*e),this._box2DBody.GetPosition())}applyImpulseTowardPosition(t,e,i){this._box2DBody===null&&this.createBody();const s=Math.atan2(e*this._sharedData.invScaleY+this._box2DBody.GetPosition().get_y(),t*this._sharedData.invScaleX-this._box2DBody.GetPosition().get_x());this._box2DBody.ApplyLinearImpulse(this.b2Vec2(Math.cos(s)*i,-Math.sin(s)*i),this._box2DBody.GetPosition())}applyForce(t,e){this._box2DBody===null&&this.createBody(),this._box2DBody.ApplyForce(this.b2Vec2(t,-e),this._box2DBody.GetPosition())}applyForceUsingPolarCoordinates(t,e){t=n.toRad(t),this._box2DBody===null&&this.createBody(),this._box2DBody.ApplyForce(this.b2Vec2(Math.cos(t)*e,-Math.sin(t)*e),this._box2DBody.GetPosition())}applyForceTowardPosition(t,e,i){this._box2DBody===null&&this.createBody();const s=Math.atan2(e*this._sharedData.invScaleY+this._box2DBody.GetPosition().get_y(),t*this._sharedData.invScaleX-this._box2DBody.GetPosition().get_x());this._box2DBody.ApplyForce(this.b2Vec2(Math.cos(s)*i,-Math.sin(s)*i),this._box2DBody.GetPosition())}applyTorque(t){this._box2DBody===null&&this.createBody(),this._box2DBody.ApplyTorque(t)}setLinearVelocity(t,e){this._box2DBody===null&&this.createBody(),this._box2DBody.SetLinearVelocity(this.b2Vec2(t,-e))}setAngularVelocity(t){this._box2DBody===null&&this.createBody(),this._box2DBody.SetAngularVelocity(t)}setLinearDamping(t){this._box2DBody===null&&this.createBody(),this._box2DBody.SetLinearDamping(t)}setAngularDamping(t){this._box2DBody===null&&this.createBody(),this._box2DBody.SetAngularDamping(t)}addRevoluteJointBetweenObjects(t,e,i,s){if(this._box2DBody===null&&this.createBody(),t==null||!t.hasBehavior(this.name))return;const a=t.getBehavior(this.name).getBox2DBody();if(this._box2DBody==a)return;const o=new Box2D.b2RevoluteJointDef;o.Initialize(this._box2DBody,a,this.b2Vec2(i*this._sharedData.invScaleX+this._box2DBody.GetWorldCenter().get_x(),s*this._sharedData.invScaleY+this._box2DBody.GetWorldCenter().get_y())),this._sharedData.world.CreateJoint(o)}addRevoluteJoint(t,e){this._box2DBody===null&&this.createBody();const i=new Box2D.b2RevoluteJointDef;i.Initialize(this._box2DBody,this._sharedData.staticBody,this.b2Vec2(t*this._sharedData.invScaleX,-e*this._sharedData.invScaleY)),this._sharedData.world.CreateJoint(i)}setGravity(t,e){this._box2DBody===null&&this.createBody(),this._sharedData.world.SetGravity(this.b2Vec2(t,-e))}addGearJointBetweenObjects(t,e){if(this._box2DBody===null&&this.createBody(),t==null||!t.hasBehavior(this.name))return;const i=t.getBehavior(this.name).getBox2DBody();if(this._box2DBody==i)return;const s=new Box2D.b2RevoluteJointDef;s.Initialize(this._sharedData.world.GetGroundBody(),this._box2DBody,this._box2DBody.GetWorldCenter());const a=new Box2D.b2RevoluteJointDef;a.Initialize(this._sharedData.world.GetGroundBody(),i,i.GetWorldCenter());const o=new Box2D.b2GearJointDef;o.set_bodyA(this._box2DBody),o.set_bodyB(i),o.set_joint1(this._sharedData.world.CreateJoint(s)),o.set_joint2(this._sharedData.world.CreateJoint(a)),o.set_ratio(e*3.14159),this._sharedData.world.CreateJoint(o)}setLinearVelocityX(t){this._box2DBody===null&&this.createBody(),this._box2DBody.SetLinearVelocity(this.b2Vec2(t,this._box2DBody.GetLinearVelocity().get_y()))}setLinearVelocityY(t){this._box2DBody===null&&this.createBody(),this._box2DBody.SetLinearVelocity(this.b2Vec2(this._box2DBody.GetLinearVelocity().get_x(),-t))}getLinearVelocityX(){return this._box2DBody===null&&this.createBody(),this._box2DBody.GetLinearVelocity().get_x()}getLinearVelocityY(){return this._box2DBody===null&&this.createBody(),-this._box2DBody.GetLinearVelocity().get_y()}getLinearVelocity(){return this._box2DBody===null&&this.createBody(),Math.sqrt(this._box2DBody.GetLinearVelocity().get_x()*this._box2DBody.GetLinearVelocity().get_x()+this._box2DBody.GetLinearVelocity().get_y()*this._box2DBody.GetLinearVelocity().get_y())}getAngularVelocity(){return this._box2DBody===null&&this.createBody(),this._box2DBody.GetAngularVelocity()}getLinearDamping(){return this._box2DBody===null&&this.createBody(),this._box2DBody.GetLinearDamping()}getAngularDamping(){return this._box2DBody===null&&this.createBody(),this._box2DBody.GetAngularDamping()}collisionWith(t){this._box2DBody===null&&this.createBody();const e=n.staticArray(d.prototype.collisionWith);e.length=0;const i=n.staticArray2(d.prototype.collisionWith);t.values(i);for(let s=0,a=i.length;s<a;++s)e.push.apply(e,i[s]);for(let s=0,a=e.length;s<a;++s)for(let o=0,r=this.currentContacts.length;o<r;++o)if(this.currentContacts[o].owner.id===e[s].id)return!0;return!1}isStatic(){return!this._dynamic}isDynamic(){return this._dynamic}}n.PhysicsRuntimeBehavior=d,n.registerBehavior("PhysicsBehavior::PhysicsBehavior",n.PhysicsRuntimeBehavior)})(gdjs||(gdjs={}));
//# sourceMappingURL=physicsruntimebehavior.js.map
