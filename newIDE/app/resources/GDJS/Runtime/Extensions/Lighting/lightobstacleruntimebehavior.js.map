{
  "version": 3,
  "sources": ["../../../../../../../Extensions/Lighting/lightobstacleruntimebehavior.ts"],
  "sourcesContent": ["namespace gdjs {\n  declare var rbush: any;\n\n  export class LightObstaclesManager {\n    _obstacleRBush: any;\n\n    constructor(instanceContainer: gdjs.RuntimeInstanceContainer) {\n      this._obstacleRBush = new rbush();\n    }\n\n    /**\n     * Get the light obstacles manager of an instance container.\n     */\n    static getManager(\n      instanceContainer: gdjs.RuntimeInstanceContainer\n    ): gdjs.LightObstaclesManager {\n      // @ts-ignore\n      if (!instanceContainer._lightObstaclesManager) {\n        // Create the shared manager if necessary.\n        // @ts-ignore\n        instanceContainer._lightObstaclesManager = new gdjs.LightObstaclesManager(\n          instanceContainer\n        );\n      }\n      // @ts-ignore\n      return instanceContainer._lightObstaclesManager;\n    }\n\n    /**\n     * Add a light obstacle to the list of existing obstacles.\n     */\n    addObstacle(obstacle: gdjs.LightObstacleRuntimeBehavior) {\n      if (obstacle.currentRBushAABB)\n        obstacle.currentRBushAABB.updateAABBFromOwner();\n      else obstacle.currentRBushAABB = new gdjs.BehaviorRBushAABB(obstacle);\n      this._obstacleRBush.insert(obstacle.currentRBushAABB);\n    }\n\n    /**\n     * Remove a light obstacle from the list of existing obstacles. Be sure that the obstacle was\n     * added before.\n     */\n    removeObstacle(obstacle: gdjs.LightObstacleRuntimeBehavior) {\n      this._obstacleRBush.remove(obstacle.currentRBushAABB);\n    }\n\n    /**\n     * Returns all the light obstacles around the specified object.\n     * @param object The object\n     * @param radius Radius of the area to be searched.\n     * @param result An array with all obstacles near the object.\n     */\n    getAllObstaclesAround(\n      object: gdjs.RuntimeObject,\n      radius: number,\n      result: gdjs.LightObstacleRuntimeBehavior[]\n    ): void {\n      // TODO: This would better be done using the object AABB (getAABB), as (`getCenterX`;`getCenterY`) point\n      // is not necessarily in the middle of the object (for sprites for example).\n      const x = object.getX();\n      const y = object.getY();\n      const searchArea = gdjs.staticObject(\n        LightObstaclesManager.prototype.getAllObstaclesAround\n      );\n      // @ts-ignore\n      searchArea.minX = x - radius;\n      // @ts-ignore\n      searchArea.minY = y - radius;\n      // @ts-ignore\n      searchArea.maxX = x + radius;\n      // @ts-ignore\n      searchArea.maxY = y + radius;\n      const nearbyObstacles: gdjs.BehaviorRBushAABB<\n        gdjs.LightObstacleRuntimeBehavior\n      >[] = this._obstacleRBush.search(searchArea);\n      result.length = 0;\n      nearbyObstacles.forEach((nearbyObstacle) =>\n        result.push(nearbyObstacle.behavior)\n      );\n    }\n  }\n\n  export class LightObstacleRuntimeBehavior extends gdjs.RuntimeBehavior {\n    _oldX: float = 0;\n    _oldY: float = 0;\n    _oldWidth: float = 0;\n    _oldHeight: float = 0;\n    currentRBushAABB: gdjs.BehaviorRBushAABB<\n      LightObstacleRuntimeBehavior\n    > | null = null;\n    _manager: any;\n    _registeredInManager: boolean = false;\n\n    constructor(\n      instanceContainer: gdjs.RuntimeInstanceContainer,\n      behaviorData,\n      owner: gdjs.RuntimeObject\n    ) {\n      super(instanceContainer, behaviorData, owner);\n      this._manager = LightObstaclesManager.getManager(instanceContainer);\n    }\n\n    doStepPreEvents(instanceContainer: gdjs.RuntimeInstanceContainer) {\n      // Make sure the obstacle is or is not in the obstacles manager.\n      if (!this.activated() && this._registeredInManager) {\n        this._manager.removeObstacle(this);\n        this._registeredInManager = false;\n      } else {\n        if (this.activated() && !this._registeredInManager) {\n          this._manager.addObstacle(this);\n          this._registeredInManager = true;\n        }\n      }\n\n      //Track changes in size or position\n      if (\n        this._oldX !== this.owner.getX() ||\n        this._oldY !== this.owner.getY() ||\n        this._oldWidth !== this.owner.getWidth() ||\n        this._oldHeight !== this.owner.getHeight()\n      ) {\n        if (this._registeredInManager) {\n          this._manager.removeObstacle(this);\n          this._manager.addObstacle(this);\n        }\n        this._oldX = this.owner.getX();\n        this._oldY = this.owner.getY();\n        this._oldWidth = this.owner.getWidth();\n        this._oldHeight = this.owner.getHeight();\n      }\n    }\n\n    onDestroy() {\n      if (this._manager && this._registeredInManager) {\n        this._manager.removeObstacle(this);\n      }\n    }\n\n    onActivate() {\n      if (this._registeredInManager) {\n        return;\n      }\n      this._manager.addObstacle(this);\n      this._registeredInManager = true;\n    }\n\n    onDeActivate() {\n      if (!this._registeredInManager) {\n        return;\n      }\n      this._manager.removeObstacle(this);\n      this._registeredInManager = false;\n    }\n  }\n  gdjs.registerBehavior(\n    'Lighting::LightObstacleBehavior',\n    gdjs.LightObstacleRuntimeBehavior\n  );\n}\n"],
  "mappings": "AAAA,GAAU,MAAV,UAAU,EAAV,CAGS,OAA4B,CAGjC,YAAY,EAAkD,CAC5D,KAAK,eAAiB,GAAI,aAMrB,YACL,EAC4B,CAE5B,MAAK,GAAkB,wBAGrB,GAAkB,uBAAyB,GAAI,GAAK,sBAClD,IAIG,EAAkB,uBAM3B,YAAY,EAA6C,CACvD,AAAI,EAAS,iBACX,EAAS,iBAAiB,sBACvB,EAAS,iBAAmB,GAAI,GAAK,kBAAkB,GAC5D,KAAK,eAAe,OAAO,EAAS,kBAOtC,eAAe,EAA6C,CAC1D,KAAK,eAAe,OAAO,EAAS,kBAStC,sBACE,EACA,EACA,EACM,CAGN,KAAM,GAAI,EAAO,OACX,EAAI,EAAO,OACX,EAAa,EAAK,aACtB,EAAsB,UAAU,uBAGlC,EAAW,KAAO,EAAI,EAEtB,EAAW,KAAO,EAAI,EAEtB,EAAW,KAAO,EAAI,EAEtB,EAAW,KAAO,EAAI,EACtB,KAAM,GAEA,KAAK,eAAe,OAAO,GACjC,EAAO,OAAS,EAChB,EAAgB,QAAQ,AAAC,GACvB,EAAO,KAAK,EAAe,YA1E1B,EAAM,wBA+EN,eAA2C,GAAK,eAAgB,CAWrE,YACE,EACA,EACA,EACA,CACA,MAAM,EAAmB,EAAc,GAfzC,WAAe,EACf,WAAe,EACf,eAAmB,EACnB,gBAAoB,EACpB,sBAEW,KAEX,0BAAgC,GAQ9B,KAAK,SAAW,EAAsB,WAAW,GAGnD,gBAAgB,EAAkD,CAEhE,AAAI,CAAC,KAAK,aAAe,KAAK,qBAC5B,MAAK,SAAS,eAAe,MAC7B,KAAK,qBAAuB,IAExB,KAAK,aAAe,CAAC,KAAK,sBAC5B,MAAK,SAAS,YAAY,MAC1B,KAAK,qBAAuB,IAM9B,MAAK,QAAU,KAAK,MAAM,QAC1B,KAAK,QAAU,KAAK,MAAM,QAC1B,KAAK,YAAc,KAAK,MAAM,YAC9B,KAAK,aAAe,KAAK,MAAM,cAE3B,MAAK,sBACP,MAAK,SAAS,eAAe,MAC7B,KAAK,SAAS,YAAY,OAE5B,KAAK,MAAQ,KAAK,MAAM,OACxB,KAAK,MAAQ,KAAK,MAAM,OACxB,KAAK,UAAY,KAAK,MAAM,WAC5B,KAAK,WAAa,KAAK,MAAM,aAIjC,WAAY,CACV,AAAI,KAAK,UAAY,KAAK,sBACxB,KAAK,SAAS,eAAe,MAIjC,YAAa,CACX,AAAI,KAAK,sBAGT,MAAK,SAAS,YAAY,MAC1B,KAAK,qBAAuB,IAG9B,cAAe,CACb,AAAI,CAAC,KAAK,sBAGV,MAAK,SAAS,eAAe,MAC7B,KAAK,qBAAuB,KArEzB,EAAM,+BAwEb,EAAK,iBACH,kCACA,EAAK,gCA5JC",
  "names": []
}
