{
  "version": 3,
  "sources": ["../../../../../GDJS/Runtime/Model3DManager.ts"],
  "sourcesContent": ["/*\n * GDevelop JS Platform\n * Copyright 2013-present Florian Rival (Florian.Rival@gmail.com). All rights reserved.\n * This project is released under the MIT License.\n */\nnamespace gdjs {\n  const logger = new gdjs.Logger('Model3DManager');\n  type OnProgressCallback = (loadedCount: integer, totalCount: integer) => void;\n  type OnCompleteCallback = (totalCount: integer) => void;\n\n  /**\n   * Load GLB files (using `Three.js`), using the \"model3D\" resources\n   * registered in the game resources.\n   */\n  export class Model3DManager {\n    /**\n     * Map associating a resource name to the loaded Three.js model.\n     */\n    private _loadedThreeModels = new Map<String, THREE.Object3D>();\n\n    _resourcesLoader: RuntimeGameResourcesLoader;\n    _resources: ResourceData[];\n\n    _loader: THREE_ADDONS.GLTFLoader | null = null;\n    _dracoLoader: THREE_ADDONS.DRACOLoader | null = null;\n\n    _invalidModel: THREE.Object3D | null = null;\n\n    /**\n     * @param resources The resources data of the game.\n     * @param resourcesLoader The resources loader of the game.\n     */\n    constructor(\n      resources: ResourceData[],\n      resourcesLoader: RuntimeGameResourcesLoader\n    ) {\n      this._resources = resources;\n      this._resourcesLoader = resourcesLoader;\n\n      if (typeof THREE !== 'undefined') {\n        this._loader = new THREE_ADDONS.GLTFLoader();\n\n        this._dracoLoader = new THREE_ADDONS.DRACOLoader();\n        this._dracoLoader.setDecoderPath('./pixi-renderers/draco/gltf/');\n        this._loader.setDRACOLoader(this._dracoLoader);\n\n        /**\n         * The invalid model is a box with magenta (#ff00ff) faces, to be\n         * easily spotted if rendered on screen.\n         */\n        const geometry = new THREE.BoxGeometry(1, 1, 1);\n        const material = new THREE.MeshBasicMaterial({ color: '#ff00ff' });\n        this._invalidModel = new THREE.Mesh(geometry, material);\n      }\n    }\n\n    /**\n     * Update the resources data of the game. Useful for hot-reloading, should not be used otherwise.\n     *\n     * @param resources The resources data of the game.\n     */\n    setResources(resources: ResourceData[]): void {\n      this._resources = resources;\n    }\n\n    /**\n     * Load all the 3D models.\n     *\n     * Note that even if a file is already loaded, it will be reloaded (useful for hot-reloading,\n     * as files can have been modified without the editor knowing).\n     *\n     * @param onProgress The function called after each file is loaded.\n     * @param onComplete The function called when all file are loaded.\n     */\n    loadModels(\n      onProgress: OnProgressCallback,\n      onComplete: OnCompleteCallback\n    ): void {\n      const resources = this._resources;\n      const model3DResources = resources.filter(function (resource) {\n        return resource.kind === 'model3D';\n      });\n      if (model3DResources.length === 0 || !this._loader) {\n        return onComplete(model3DResources.length);\n      }\n\n      let loaded = 0;\n      for (let i = 0; i < model3DResources.length; ++i) {\n        const resource = model3DResources[i];\n        const url = this._resourcesLoader.getFullUrl(resource.file);\n\n        this._loader.withCredentials = this._resourcesLoader.checkIfCredentialsRequired(\n          url\n        );\n        this._loader.load(\n          url,\n          (gltf: THREE_ADDONS.GLTF) => {\n            // Iterate over loaded texture as a fix for https://forum.gdevelop.io/t/dark-textures-on-3d-models/47575.\n            // TODO (3D): Investigate if it's a legitimate thing to do or if the loaded glb file should be\n            // adapted so that loader uses the \"correct\" encoding.\n            gltf.scene.traverse((object) => {\n              if ((object as THREE.Mesh).isMesh) {\n                // @ts-ignore - The typing is not accurate here.\n                const texture = (object as THREE.Mesh).material.map;\n                if (texture && texture.isTexture) {\n                  texture.encoding = THREE.LinearEncoding;\n                }\n              }\n            });\n            gltf.scene.rotation.order = 'ZYX';\n            this._loadedThreeModels.set(resource.name, gltf.scene);\n\n            loaded++;\n            if (loaded === model3DResources.length) {\n              onComplete(model3DResources.length);\n            } else {\n              onProgress(loaded, model3DResources.length);\n            }\n          },\n          undefined,\n          (error) => {\n            logger.error(error);\n\n            loaded++;\n            if (loaded === model3DResources.length) {\n              onComplete(model3DResources.length);\n            } else {\n              onProgress(loaded, model3DResources.length);\n            }\n          }\n        );\n      }\n    }\n\n    /**\n     * Return a 3D model.\n     *\n     * Caller should not modify the object but clone it.\n     *\n     * @param resourceName The name of the json resource.\n     * @returns a 3D model if it exists.\n     */\n    getModel(resourceName: string): THREE.Object3D | null {\n      return this._loadedThreeModels.get(resourceName) || this._invalidModel;\n    }\n  }\n}\n"],
  "mappings": "AAKA,GAAU,MAAV,UAAU,EAAV,CACE,KAAM,GAAS,GAAI,GAAK,OAAO,kBAQxB,OAAqB,CAkB1B,YACE,EACA,EACA,CAjBM,wBAAqB,GAAI,KAKjC,aAA0C,KAC1C,kBAAgD,KAEhD,mBAAuC,KAarC,GAHA,KAAK,WAAa,EAClB,KAAK,iBAAmB,EAEpB,MAAO,QAAU,YAAa,CAChC,KAAK,QAAU,GAAI,cAAa,WAEhC,KAAK,aAAe,GAAI,cAAa,YACrC,KAAK,aAAa,eAAe,gCACjC,KAAK,QAAQ,eAAe,KAAK,cAMjC,KAAM,GAAW,GAAI,OAAM,YAAY,EAAG,EAAG,GACvC,EAAW,GAAI,OAAM,kBAAkB,CAAE,MAAO,YACtD,KAAK,cAAgB,GAAI,OAAM,KAAK,EAAU,IASlD,aAAa,EAAiC,CAC5C,KAAK,WAAa,EAYpB,WACE,EACA,EACM,CAEN,KAAM,GAAmB,AADP,KAAK,WACY,OAAO,SAAU,EAAU,CAC5D,MAAO,GAAS,OAAS,YAE3B,GAAI,EAAiB,SAAW,GAAK,CAAC,KAAK,QACzC,MAAO,GAAW,EAAiB,QAGrC,GAAI,GAAS,EACb,OAAS,GAAI,EAAG,EAAI,EAAiB,OAAQ,EAAE,EAAG,CAChD,KAAM,GAAW,EAAiB,GAC5B,EAAM,KAAK,iBAAiB,WAAW,EAAS,MAEtD,KAAK,QAAQ,gBAAkB,KAAK,iBAAiB,2BACnD,GAEF,KAAK,QAAQ,KACX,EACA,AAAC,GAA4B,CAI3B,EAAK,MAAM,SAAS,AAAC,GAAW,CAC9B,GAAK,EAAsB,OAAQ,CAEjC,KAAM,GAAW,EAAsB,SAAS,IAChD,AAAI,GAAW,EAAQ,WACrB,GAAQ,SAAW,MAAM,mBAI/B,EAAK,MAAM,SAAS,MAAQ,MAC5B,KAAK,mBAAmB,IAAI,EAAS,KAAM,EAAK,OAEhD,IACA,AAAI,IAAW,EAAiB,OAC9B,EAAW,EAAiB,QAE5B,EAAW,EAAQ,EAAiB,SAGxC,OACA,AAAC,GAAU,CACT,EAAO,MAAM,GAEb,IACA,AAAI,IAAW,EAAiB,OAC9B,EAAW,EAAiB,QAE5B,EAAW,EAAQ,EAAiB,WAe9C,SAAS,EAA6C,CACpD,MAAO,MAAK,mBAAmB,IAAI,IAAiB,KAAK,eAjItD,EAAM,mBATL",
  "names": []
}
