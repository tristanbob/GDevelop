var gdjs;(function(l){const c=new l.Logger("Hot reloader");class m{constructor(i){this._reloadedScriptElement={};this._logs=[];this._alreadyLoadedScriptFiles={};this._runtimeGame=i}static groupByPersistentUuid(i){return i.reduce(function(e,r){return r.persistentUuid&&(e[r.persistentUuid]=r),e},{})}_canReloadScriptFile(i){function e(r,t){const o=r.indexOf(t);return o!==-1&&o===r.length-t.length}return!(e(i,".h")||this._alreadyLoadedScriptFiles[i]&&(e(i,"box2d.js")||e(i,"sha256.js")||e(i,"shifty.js")||e(i,"shopify-buy.umd.polyfilled.min.js")||e(i,"pixi-multistyle-text.umd.js")||e(i,"pixi-tilemap.umd.js")||e(i,"bondage.min.js")||e(i,"pixi-particles-pixi-renderer.min.js")||e(i,"pixi-tilemap.umd.js")||e(i,"pixi-tilemap-helper.js")||e(i,"pako/dist/pako.min")))}_reloadScript(i){function e(t,o){const a=t.indexOf(o);return a!==-1&&a===t.length-o.length}if(!this._canReloadScriptFile(i))return this._logs.push({kind:"info",message:"Not reloading "+i+" as it is blocked for hot-reloading."}),Promise.resolve();const r=document.getElementsByTagName("head")[0];return r?new Promise((t,o)=>{const a=this._reloadedScriptElement[i];if(a)r.removeChild(a);else{const n=r.getElementsByTagName("script");for(let h=0;h<n.length;++h){const d=n[h];e(d.src,i)&&r.removeChild(d)}}const s=document.createElement("script");s.src=i+"?timestamp="+Date.now(),s.onload=()=>{t()},s.onerror=n=>{o(n)},r.appendChild(s),this._reloadedScriptElement[i]=s}):Promise.reject(new Error("No head element found, are you in a navigator?"))}hotReload(){c.info("Hot reload started"),this._runtimeGame.pause(!0),this._logs=[];const i=l.projectData,e=l.runtimeGameOptions.scriptFiles;e.forEach(t=>{this._alreadyLoadedScriptFiles[t.path]=!0});const r={};for(let t in l.behaviorsTypes.items)r[t]=l.behaviorsTypes.items[t];return this._reloadScript("data.js").then(()=>{const t=l.projectData,o=l.runtimeGameOptions,a=o.scriptFiles,s=!!o.projectDataOnlyExport;return this.reloadScriptFiles(t,e,a,s).then(()=>{const n=this._computeChangedRuntimeBehaviors(r,l.behaviorsTypes.items);return this._hotReloadRuntimeGame(i,t,n,this._runtimeGame)}).catch(n=>{const h=n.target;h instanceof HTMLScriptElement?this._logs.push({kind:"fatal",message:"Unable to reload script:"+h.src}):this._logs.push({kind:"fatal",message:"Unexpected error happened while hot-reloading:"+n.message})}).then(()=>(c.info("Hot reload finished with logs:",this._logs),this._runtimeGame.pause(!1),this._logs))})}_computeChangedRuntimeBehaviors(i,e){const r=[];for(let t in i){const o=i[t],a=e[t];a?o!==a&&(this._logs.push({kind:"info",message:"Behavior with type "+t+" was changed, and will be re-instantiated in gdjs.RuntimeObjects using it."}),r.push({oldBehaviorConstructor:o,newBehaviorConstructor:a,behaviorTypeName:t})):this._logs.push({kind:"warning",message:"Behavior with type "+t+" was removed from the registered behaviors in gdjs."})}return r}reloadScriptFiles(i,e,r,t){const o=[];t||i.layouts.forEach((a,s)=>{o.push(this._reloadScript("code"+s+".js"))});for(let a=0;a<r.length;++a){const s=r[a],n=e.filter(h=>h.path===s.path)[0];n?s.hash!==n.hash&&(this._logs.push({kind:"info",message:"Reloading "+s.path+" because it was changed."}),o.push(this._reloadScript(s.path))):(this._logs.push({kind:"info",message:"Loading "+s.path+" as it was added to the list of scripts."}),o.push(this._reloadScript(s.path)))}for(let a=0;a<e.length;++a){const s=e[a];!r.filter(h=>h.path===s.path)[0]&&!t&&this._logs.push({kind:"warning",message:"Script file "+s.path+" was removed."})}return Promise.all(o)}_hotReloadRuntimeGame(i,e,r,t){return new Promise(o=>{t.setProjectData(e),t.loadAllAssets(()=>{this._hotReloadVariablesContainer(i.variables,e.variables,t.getVariables());const a=t.getSceneStack();a._stack.forEach(s=>{const n=i.layouts.filter(d=>d.name===s.getName())[0],h=e.layouts.filter(d=>d.name===s.getName())[0];n&&h?this._hotReloadRuntimeScene(n,h,r,s):this._logs.push({kind:"error",message:"Scene "+n.name+" was removed. A fresh preview should be launched."})}),e.externalLayouts.forEach(s=>{const n=i.externalLayouts.filter(h=>h.name===s.name)[0];n&&!m.deepEqual(n,s)&&a._stack.forEach(h=>{this._hotReloadRuntimeSceneInstances(n.instances,s.instances,h)})}),o()})})}_hotReloadVariablesContainer(i,e,r){e.forEach(t=>{const o=t.name,a=i.find(n=>n.name===o),s=r.get(t.name);a?l.Variable.isPrimitive(t.type||"number")&&(a.value!==t.value||!l.Variable.isPrimitive(a.type||"number"))?(r.remove(o),r.add(o,new l.Variable(t))):l.Variable.isPrimitive(t.type||"number")||(t.type==="structure"?this._hotReloadStructureVariable(a.children,t.children,s):(r.remove(o),r.add(o,new l.Variable(t)))):r.add(o,new l.Variable(t))}),i.forEach(t=>{e.find(a=>a.name===t.name)||r.remove(t.name)})}_hotReloadStructureVariable(i,e,r){i?(i.forEach(t=>{const o=e.find(a=>a.name===t.name);o?l.Variable.isPrimitive(o.type||"number")&&(t.value!==o.value||!l.Variable.isPrimitive(t.type||"number"))?r.addChild(o.name,new l.Variable(o)):l.Variable.isPrimitive(o.type||"number")||(o.type==="structure"?this._hotReloadStructureVariable(t.children,o.children,r.getChild(o.name)):r.addChild(o.name,new l.Variable(o))):r.removeChild(t.name)}),e.forEach(t=>{i.find(a=>a.name===t.name)||r.addChild(t.name,new l.Variable(t))})):e.forEach(t=>{r.addChild(t.name,new l.Variable(t))})}_hotReloadRuntimeScene(i,e,r,t){t.setBackgroundColor(e.r,e.v,e.b),i.title!==e.title&&t.getGame().getRenderer().setWindowTitle(e.title),this._hotReloadVariablesContainer(i.variables,e.variables,t.getVariables()),this._hotReloadRuntimeSceneBehaviorsSharedData(i.behaviorsSharedData,e.behaviorsSharedData,t),this._reinstantiateRuntimeSceneRuntimeBehaviors(r,e.objects,t),this._hotReloadRuntimeSceneObjects(i.objects,e.objects,t),this._hotReloadRuntimeSceneInstances(i.instances,e.instances,t),this._hotReloadRuntimeSceneLayers(i.layers,e.layers,t),t.setEventsGeneratedCodeFunction(e)}_hotReloadRuntimeSceneBehaviorsSharedData(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];a?m.deepEqual(t,a)||r.setInitialSharedDataForBehavior(a.name,a):r.setInitialSharedDataForBehavior(t.name,null)}),e.forEach(t=>{const o=t.name;i.filter(s=>s.name===o)[0]||r.setInitialSharedDataForBehavior(t.name,t)})}_reinstantiateRuntimeSceneRuntimeBehaviors(i,e,r){e.forEach(t=>{const o=t.name,a=t.behaviors,s=r.getObjects(o);i.forEach(n=>{const h=n.behaviorTypeName;a.filter(d=>d.type===h).forEach(d=>{const f=d.name;this._logs.push({kind:"info",message:'Re-instantiating behavior named "'+f+'" for instances of object "'+o+'".'}),s.forEach(u=>{this._reinstantiateRuntimeObjectRuntimeBehavior(d,u)})})})})}_reinstantiateRuntimeObjectRuntimeBehavior(i,e){const r=i.name,t=e.getBehavior(r);if(!t)return;e.removeBehavior(r),e.addNewBehavior(i);const o=e.getBehavior(r);if(!o){this._logs.push({kind:"error",message:"Could not create behavior "+r+" (type: "+i.type+") for object "+e.getName()});return}for(let a in t)if(!!t.hasOwnProperty(a))if(a==="_behaviorData"){o[a]=o[a]||{};for(let s in t[a])o[a][s]=t[a][s]}else o[a]=t[a]}_hotReloadRuntimeSceneObjects(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];!a||t.type!==a.type?r.unregisterObject(o):r.isObjectRegistered(o)&&this._hotReloadRuntimeSceneObject(t,a,r)}),e.forEach(t=>{const o=t.name,a=i.filter(s=>s.name===o)[0];(!a||a.type!==t.type)&&!r.isObjectRegistered(o)&&r.registerObject(t)})}_hotReloadRuntimeSceneObject(i,e,r){let t=!0;if(!m.deepEqual(i,e)){this._logs.push({kind:"info",message:'Object "'+e.name+'" was modified and is hot-reloaded.'}),r.updateObject(e);const o=r.getObjects(e.name);o.forEach(a=>{t=a.updateFromObjectData(i,e)&&t}),o.forEach(a=>{this._hotReloadVariablesContainer(i.variables,e.variables,a.getVariables())}),this._hotReloadRuntimeObjectsBehaviors(i.behaviors,e.behaviors,o),this._hotReloadRuntimeObjectsEffects(i.effects,e.effects,o)}t||this._logs.push({kind:"error",message:'Object "'+e.name+'" could not be hot-reloaded. A fresh preview should be run.'})}_hotReloadRuntimeObjectsBehaviors(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];if(!a)r.forEach(s=>{s.hasBehavior(o)&&(s.removeBehavior(o)||this._logs.push({kind:"error",message:"Behavior "+o+" could not be removed from object"+s.getName()}))});else if(!m.deepEqual(t,a)){let s=!0;r.forEach(n=>{const h=n.getBehavior(a.name);h&&(s=this._hotReloadRuntimeBehavior(t,a,h)&&s)}),s||this._logs.push({kind:"error",message:a.name+" behavior could not be hot-reloaded."})}}),e.forEach(t=>{const o=t.name;if(!i.filter(s=>s.name===o)[0]){let s=!0;r.forEach(n=>{s=n.addNewBehavior(t)&&s}),s||this._logs.push({kind:"error",message:t.name+" behavior could not be added during hot-reload."})}})}_hotReloadRuntimeObjectsEffects(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];if(!a)r.forEach(s=>{s.hasEffect(o)&&(s.removeEffect(o)||this._logs.push({kind:"error",message:"Effect "+o+" could not be removed from object"+s.getName()}))});else if(!m.deepEqual(t,a)){let s=!0;r.forEach(n=>{t.effectType===a.effectType?s=n.updateAllEffectParameters(a)&&s:(n.removeEffect(t.name),n.addEffect(a))}),s||this._logs.push({kind:"error",message:a.name+" effect could not be hot-reloaded."})}}),e.forEach(t=>{const o=t.name;if(!i.filter(s=>s.name===o)[0]){let s=!0;r.forEach(n=>{s=n.addEffect(t)&&s}),s||this._logs.push({kind:"error",message:t.name+" effect could not be added during hot-reload."})}})}_hotReloadRuntimeBehavior(i,e,r){return r.updateFromBehaviorData(i,e)}_hotReloadRuntimeSceneLayers(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];if(!a)r.removeLayer(o);else if(r.hasLayer(o)){const s=r.getLayer(o);this._hotReloadRuntimeLayer(t,a,s)}}),e.forEach(t=>{const o=t.name;!i.filter(s=>s.name===o)[0]&&!r.hasLayer(o)&&r.addLayer(t)}),e.forEach((t,o)=>{r.setLayerIndex(t.name,o)})}_hotReloadRuntimeLayer(i,e,r){i.visibility!==e.visibility&&r.show(e.visibility),e.isLightingLayer&&((i.ambientLightColorR!==e.ambientLightColorR||i.ambientLightColorG!==e.ambientLightColorG||i.ambientLightColorB!==e.ambientLightColorB)&&r.setClearColor(e.ambientLightColorR,e.ambientLightColorG,e.ambientLightColorB),i.followBaseLayerCamera!==e.followBaseLayerCamera&&r.setFollowBaseLayerCamera(e.followBaseLayerCamera)),i.renderingType!==e.renderingType&&this._logs.push({kind:"error",message:`Could not change the rendering type (2D, 3D...) layer at runtime (for layer "${e.name}").`}),e.isLightingLayer!==i.isLightingLayer&&this._logs.push({kind:"error",message:`Could not add/remove a lighting layer at runtime (for layer "${e.name}").`}),this._hotReloadRuntimeLayerEffects(i.effects,e.effects,r)}_hotReloadRuntimeLayerEffects(i,e,r){i.forEach(t=>{const o=t.name,a=e.filter(s=>s.name===o)[0];a?r.hasEffect(o)&&(t.effectType!==a.effectType?(r.removeEffect(o),r.addEffect(a)):this._hotReloadRuntimeLayerEffect(t,a,r,o)):r.removeEffect(o)}),e.forEach(t=>{const o=t.name;!i.filter(s=>s.name===o)[0]&&!r.hasEffect(o)&&r.addEffect(t)})}_hotReloadRuntimeLayerEffect(i,e,r,t){for(let o in e.booleanParameters){const a=e.booleanParameters[o];a!==i.booleanParameters[o]&&r.setEffectBooleanParameter(t,o,a)}for(let o in e.doubleParameters){const a=e.doubleParameters[o];a!==i.doubleParameters[o]&&r.setEffectDoubleParameter(t,o,a)}for(let o in e.stringParameters){const a=e.stringParameters[o];a!==i.stringParameters[o]&&r.setEffectStringParameter(t,o,a)}}_hotReloadRuntimeSceneInstances(i,e,r){const t=r.getAdhocListOfAllInstances(),o=m.groupByPersistentUuid(i),a=m.groupByPersistentUuid(e),s=m.groupByPersistentUuid(t);for(let n in o){const h=o[n],d=a[n],f=s[n];h&&(!d||h.name!==d.name)?f&&f.deleteFromScene(r):h&&d&&f&&this._hotReloadRuntimeInstance(h,d,f)}for(let n in a){const h=o[n],d=a[n],f=s[n];d&&(!h||h.name!==d.name)&&!f&&r.createObjectsFrom([d],0,0,!0)}}_hotReloadRuntimeInstance(i,e,r){let t=!1;i.x!==e.x&&(r.setX(e.x),t=!0),i.y!==e.y&&(r.setY(e.y),t=!0),i.angle!==e.angle&&(r.setAngle(e.angle),t=!0),i.zOrder!==e.zOrder&&(r.setZOrder(e.zOrder),t=!0),i.layer!==e.layer&&(r.setLayer(e.layer),t=!0),l.RuntimeObject3D&&r instanceof l.RuntimeObject3D&&(i.z!==e.z&&e.z!==void 0&&(r.setZ(e.z),t=!0),i.rotationX!==e.rotationX&&e.rotationX!==void 0&&(r.setRotationX(e.rotationX),t=!0),i.rotationY!==e.rotationY&&e.rotationY!==void 0&&(r.setRotationY(e.rotationY),t=!0));let o=!1;e.customSize?i.customSize?(i.width!==e.width&&(r.setWidth(e.width),t=!0,o=!0),i.height!==e.height&&(r.setHeight(e.height),t=!0,o=!0)):(r.setWidth(e.width),r.setHeight(e.height),t=!0,o=!0):!e.customSize&&i.customSize&&(o=!0),l.RuntimeObject3D&&r instanceof l.RuntimeObject3D&&(i.depth!==e.depth&&e.depth!==void 0?(r.setDepth(e.depth),t=!0,o=!0):e.depth===void 0&&i.depth!==void 0&&(o=!0)),this._hotReloadVariablesContainer(i.initialVariables,e.initialVariables,r.getVariables());const a=e.numberProperties.some(n=>{const h=n.name,d=n.value,f=i.numberProperties.filter(u=>u.name===h)[0];return!f||f.value!==d}),s=e.stringProperties.some(n=>{const h=n.name,d=n.value,f=i.stringProperties.filter(u=>u.name===h)[0];return!f||f.value!==d});(a||s||o)&&(r.extraInitializationFromInitialInstance(e),t=!0),t&&r.notifyBehaviorsObjectHotReloaded()}static deepEqual(i,e){if(i===e)return!0;if(i&&e&&typeof i=="object"&&typeof e=="object"){if(i.constructor!==e.constructor)return!1;let r,t,o;if(Array.isArray(i)){if(r=i.length,r!=e.length)return!1;for(t=r;t--!=0;)if(!m.deepEqual(i[t],e[t]))return!1;return!0}if(i.valueOf!==Object.prototype.valueOf)return i.valueOf()===e.valueOf();if(i.toString!==Object.prototype.toString)return i.toString()===e.toString();if(o=Object.keys(i),r=o.length,r!==Object.keys(e).length)return!1;for(t=r;t--!=0;)if(!Object.prototype.hasOwnProperty.call(e,o[t]))return!1;for(t=r;t--!=0;){const a=o[t];if(!m.deepEqual(i[a],e[a]))return!1}return!0}return i!==i&&e!==e}}l.HotReloader=m})(gdjs||(gdjs={}));
//# sourceMappingURL=hot-reloader.js.map
