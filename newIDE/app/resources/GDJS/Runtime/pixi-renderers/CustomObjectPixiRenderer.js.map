{
  "version": 3,
  "sources": ["../../../../../../GDJS/Runtime/pixi-renderers/CustomObjectPixiRenderer.ts"],
  "sourcesContent": ["namespace gdjs {\n  import PIXI = GlobalPIXIModule.PIXI;\n\n  /**\n   * The renderer for a {@link gdjs.CustomRuntimeObject} using Pixi.js.\n   */\n  export class CustomObjectPixiRenderer\n    implements gdjs.RuntimeInstanceContainerPixiRenderer {\n    _object: gdjs.CustomRuntimeObject;\n    _instanceContainer: gdjs.CustomRuntimeObjectInstanceContainer;\n    _pixiContainer: PIXI.Container;\n    _threeGroup: THREE.Group | null;\n    _isContainerDirty: boolean = true;\n    _debugDraw: PIXI.Graphics | null = null;\n    _debugDrawContainer: PIXI.Container | null = null;\n    _debugDrawRenderedObjectsPoints: Record<\n      number,\n      {\n        wasRendered: boolean;\n        points: Record<string, PIXI.Text>;\n      }\n    >;\n\n    constructor(\n      object: gdjs.CustomRuntimeObject,\n      instanceContainer: gdjs.CustomRuntimeObjectInstanceContainer,\n      parent: gdjs.RuntimeInstanceContainer\n    ) {\n      this._object = object;\n      this._instanceContainer = instanceContainer;\n\n      // TODO (3D) - optimization: don't create a PixiJS container if only 3D objects.\n      // And same, in reverse, for 2D only objects.\n      this._pixiContainer = new PIXI.Container();\n      this._threeGroup =\n        typeof THREE !== 'undefined' ? new THREE.Group() : null;\n      this._debugDrawRenderedObjectsPoints = {};\n\n      // Contains the layers of the scene (and, optionally, debug PIXI objects).\n      this._pixiContainer.sortableChildren = true;\n      this._debugDraw = null;\n\n      const layer = parent.getLayer('');\n      if (layer) {\n        layer\n          .getRenderer()\n          .addRendererObject(this._pixiContainer, object.getZOrder());\n        if (this._threeGroup) {\n          layer.getRenderer().add3DRendererObject(this._threeGroup);\n        }\n      }\n    }\n\n    reinitialize(\n      object: gdjs.CustomRuntimeObject,\n      parent: gdjs.RuntimeInstanceContainer\n    ) {\n      this._object = object;\n      this._isContainerDirty = true;\n      const layer = parent.getLayer('');\n      if (layer) {\n        layer\n          .getRenderer()\n          .addRendererObject(this._pixiContainer, object.getZOrder());\n        if (this._threeGroup) {\n          layer.getRenderer().add3DRendererObject(this._threeGroup);\n        }\n      }\n    }\n\n    getRendererObject() {\n      return this._pixiContainer;\n    }\n\n    get3DRendererObject(): THREE.Object3D | null {\n      return this._threeGroup;\n    }\n\n    /**\n     * Update the internal PIXI.Container position, angle...\n     */\n    _updatePIXIContainer() {\n      this._pixiContainer.pivot.x = this._object.getUnscaledCenterX();\n      this._pixiContainer.pivot.y = this._object.getUnscaledCenterY();\n      this._pixiContainer.position.x =\n        this._object.getX() +\n        this._pixiContainer.pivot.x * Math.abs(this._object._scaleX);\n      this._pixiContainer.position.y =\n        this._object.getY() +\n        this._pixiContainer.pivot.y * Math.abs(this._object._scaleY);\n\n      this._pixiContainer.rotation = gdjs.toRad(this._object.angle);\n      this._pixiContainer.scale.x = this._object._scaleX;\n      this._pixiContainer.scale.y = this._object._scaleY;\n      this._pixiContainer.visible = !this._object.hidden;\n      this._pixiContainer.alpha = this._object.opacity / 255;\n\n      this._isContainerDirty = false;\n    }\n\n    _updateThreeGroup() {\n      if (!this._threeGroup) return;\n\n      const pivotX = this._object.getUnscaledCenterX();\n      const pivotY = this._object.getUnscaledCenterY();\n\n      // TODO (3D): fix the pivot point for custom objects.\n      this._threeGroup.position.x =\n        this._object.getX() + pivotX * Math.abs(this._object._scaleX);\n      this._threeGroup.position.y =\n        this._object.getY() + pivotY * Math.abs(this._object._scaleY);\n\n      this._threeGroup.rotation.z = gdjs.toRad(this._object.angle);\n      this._threeGroup.scale.x = this._object._scaleX;\n      this._threeGroup.scale.y = this._object._scaleY;\n      this._threeGroup.visible = !this._object.hidden;\n    }\n\n    /**\n     * Call this to make sure the sprite is ready to be rendered.\n     */\n    ensureUpToDate() {\n      if (this._isContainerDirty) {\n        this._updatePIXIContainer();\n        this._updateThreeGroup();\n      }\n    }\n\n    update(): void {\n      this._isContainerDirty = true;\n    }\n\n    updateX(): void {\n      this._pixiContainer.position.x =\n        this._object.x +\n        this._pixiContainer.pivot.x * Math.abs(this._object._scaleX);\n\n      if (this._threeGroup)\n        this._threeGroup.position.x =\n          this._object.getX() +\n          /*this._threeGroup.pivot.x*/ 0.5 * Math.abs(this._object._scaleX);\n    }\n\n    updateY(): void {\n      this._pixiContainer.position.y =\n        this._object.y +\n        this._pixiContainer.pivot.y * Math.abs(this._object._scaleY);\n\n      if (this._threeGroup)\n        this._threeGroup.position.y =\n          this._object.getY() +\n          /*this._threeGroup.pivot.y*/ 0.5 * Math.abs(this._object._scaleY);\n    }\n\n    updateAngle(): void {\n      this._pixiContainer.rotation = gdjs.toRad(this._object.angle);\n      if (this._threeGroup)\n        this._threeGroup.rotation.z = gdjs.toRad(this._object.angle);\n    }\n\n    updateOpacity(): void {\n      this._pixiContainer.alpha = this._object.opacity / 255;\n    }\n\n    updateVisibility(): void {\n      this._pixiContainer.visible = !this._object.hidden;\n      if (this._threeGroup) this._threeGroup.visible = !this._object.hidden;\n    }\n\n    getPIXIContainer() {\n      return this._pixiContainer;\n    }\n\n    getPIXIRenderer() {\n      return null;\n    }\n\n    setLayerIndex(layer: gdjs.RuntimeLayer, index: float): void {\n      const layerPixiRenderer: gdjs.LayerPixiRenderer = layer.getRenderer();\n      let layerPixiObject:\n        | PIXI.Container\n        | PIXI.Sprite\n        | null = layerPixiRenderer.getRendererObject();\n      if (layer.isLightingLayer()) {\n        layerPixiObject = layerPixiRenderer.getLightingSprite();\n      }\n      if (!layerPixiObject) {\n        return;\n      }\n      if (this._pixiContainer.children.indexOf(layerPixiObject) === index) {\n        return;\n      }\n      this._pixiContainer.removeChild(layerPixiObject);\n      this._pixiContainer.addChildAt(layerPixiObject, index);\n    }\n  }\n\n  // Register the class to let the engine use it.\n  export type CustomObjectRenderer = gdjs.CustomObjectPixiRenderer;\n  export const CustomObjectRenderer = gdjs.CustomObjectPixiRenderer;\n}\n"],
  "mappings": "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",
  "names": []
}
